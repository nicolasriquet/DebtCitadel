{% extends "debt_base.html" %}
{% load display_tags %}
{% load authorization_tags %}
{% load humanize %}
{% load static %}
{% load i18n %}
{% load get_endpoint_status %}
{% block add_styles %}
    {{ block.super }}
  .tooltip-inner {
    max-width: 650px;
  }
{% endblock %}
{% block add_css_before %}
    {{ block.super }}
<!-- Source Code Highlight CSS -->
<link rel="stylesheet" href="{% static "dojo/css/highlight.css" %}">
{% endblock %}
{% block content %}
    {{ block.super }}
{% user_can_clear_peer_review debt_item dojo_user as clear_peer_review %}
<div id="debt_test">
    <div class="panel panel-default">
        <div class="panel-heading">
            <div class="clearfix">
                <h3 class="pull-left debt_item-title">
                    {{ debt_item.title }}
                    {% include "dojo/snippets/tags.html" with tags=debt_item.tags.all %}
                    {% if debt_item.last_reviewed %}
                        <small>Last Reviewed {{ debt_item.last_reviewed | naturalday }}
                            by {{ debt_item.last_reviewed_by }}, </small>
                    {% else %}
                        <small>Last Reviewed {{ debt_item.date | naturalday }} by {{ debt_item.reporter }}, </small>
                    {% endif %}
                    {% if debt_item.last_status_update %}
                        <small>Last Status Update {{ debt_item.last_status_update | naturalday }}, </small>
                    {% endif %}
                    <small>Created
                    {% if debt_item.last_reviewed > debt_item.created %}
                      {{ debt_item.created | naturalday }}
                    {% else %}
                      {{ debt_item.date | naturalday }}
                    {% endif %}
                    </small>
                    {% if ladebt_test_debt_test_import_debt_item_action %}
                        <small>, Last Mentioned in (Re)Import: {{ ladebt_test_debt_test_import_debt_item_action.created | naturalday }} as {{ ladebt_test_debt_test_import_debt_item_action.get_action_display }}</small>
                    {% endif %}
                </h3>
                    <div class="dropdown pull-right">
                        <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenu1"
                                data-toggle="dropdown" aria-expanded="true">
                            <span class="fa-solid fa-bars"></span>
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-right" role="menu" aria-labelledby="dropdownMenu1">
                            {% if debt_item|has_object_permission:"Debt_Item_Edit" %}
                                <li role="presentation">
                                    <a href="{% url 'edit_debt_item' debt_item.id %}">
                                        <i class="fa-solid fa-pen-to-square"></i> Edit Debt_Item
                                    </a>
                                </li>
                                <li>
                                    <a class="" href="{% url 'copy_debt_item' debt_item.id %}?return_url={{ request.get_full_path|urlencode }}"/>
                                    <i class="fa-solid fa-copy"></i> Copy Debt_Item
                                    </a>
                                </li>
                            {% endif %}
                            {% if debt_item|has_object_permission:"Debt_Item_Edit" %}
                                <li role="presentation">
                                    <a href="{% url 'manage_files' oid=debt_item.id obj_type='Debt_Item' %}">
                                        <i class="fa-solid fa-file-image-o"></i> Manage Files
                                    </a>
                                </li>
                                <li role="separator" class="divider"></li>
                            {% endif %}
                            {% if debt_item|has_object_permission:"Debt_Item_View" %}
                                {% if debt_item|has_object_permission:"Debt_Item_Edit" and clear_peer_review %}
                                    <li role="presentation">
                                        <a href="{% url 'clear_debt_item_review' debt_item.id %}">
                                            <i class="icon-user-check"></i> Clear Review
                                        </a>
                                    </li>
                                {% elif not debt_item.under_review %}
                                    <li role="presentation">
                                        <a href="{% url 'request_debt_item_review' debt_item.id %}">
                                            <i class="icon-user-check"></i> Request Peer Review
                                        </a>
                                    </li>
                                {% endif %}
                            {% endif %}
                            {% if debt_item|has_object_permission:"Debt_Item_Edit" %}
                                <li role="presentation">
                                    <a href="{% url 'touch_debt_item' debt_item.id %}">
                                        <i class="fa-solid fa-clock"></i> Touch Debt_Item
                                    </a>
                                </li>
                            {% endif %}
                            <li role="separator" class="divider"></li>
                            {% if "Debt_Item_Add"|has_global_permission %}
                                <li role="presentation">
                                    <a href="{% url 'mktemplate' debt_item.id %}">
                                        <i class="fa-solid fa-copy"></i> Make Debt_Item a Template
                                    </a>
                                </li>
                            {% endif %}
                            {% if cwe_template.cwe and debt_item|has_object_permission:"Debt_Item_Edit" %}
                                    <li role="presentation">
                                        <a class="apply-cwe-debt_item" href="#">
                                            <i class="fa-solid fa-copy"></i> Apply CWE Template Remediation to Debt_Item
                                        </a>
                                    </li>
                                    <form id="apply-cwe-debt_item-form" method="post" action="{% url 'apply_template_cwe' debt_item.id %}">
                                        {% csrf_token %}
                                        <input type="hidden" label="apply_template" aria-label="apply_template" name="id" value="{{ debt_item.id }}"/>
                                    </form>
                            {% endif %}
                            {% if not cwe_template.cwe and "Debt_Item_Add"|has_global_permission %}
                                    <li role="presentation">
                                        <a href="{% url 'add_template' %}">
                                            <i class="fa-solid fa-copy"></i> Create a CWE Remediation Template
                                        </a>
                                    </li>
                            {% endif %}
                            {% if debt_item|has_object_permission:"Debt_Item_Edit" %}
                                <li role="presentation">
                                    <a href="{% url 'find_template_to_apply' debt_item.id %}">
                                        <i class="fa-solid fa-copy"></i> Apply Template to Debt_Item
                                    </a>
                                </li>
                            {% endif %}
                            {% if debt_item|has_object_permission:"Debt_Item_Edit" %}
                                <li role="separator" class="divider"></li>
                                    <li role="presentation">
                                        <a href="{% url 'remediation_date' debt_item.id %}">
                                            <i class="fa-solid fa-calendar-check"></i> Add/Edit Planned Remediation Date
                                        </a>
                                    </li>
                            {% endif %}
                            {% if debt_item|has_object_permission:"Debt_Item_Edit" %}
                                <li role="separator" class="divider"></li>
                                {% if debt_item.mitigated %}
                                    <li role="presentation">
                                        <a href="{% url 'reopen_debt_item' debt_item.id %}">
                                            <i class="fa-solid fa-bug"></i> Open Debt_Item
                                        </a>
                                    </li>
                                {% else %}
                                <li role="presentation">
                                    <a href="{% url 'close_debt_item' debt_item.id %}">
                                        <i class="fa-solid fa-fire-extinguisher"></i> Close Debt_Item
                                    </a>
                                </li>
                                {% endif %}
                            {% endif %}
                            {% if debt_item|has_object_permission:"Risk_Acceptance" %}
                                {% if debt_item.risk_accepted %}
                                    <li role="presentation">
                                    <a href="{% url 'risk_unaccept_debt_item' debt_item.id %}?return_url={{ request.get_full_path|urlencode }}">
                                        <i class="fa-solid fa-circle-exclamation"></i> Unaccept Risk
                                    </a>
                                    </li>
                                {% else %}
                                    {% if not debt_item.duplicate %}
                                        {% if debt_item.debt_test.debt_engagement.debt_context.enable_simple_risk_acceptance %}
                                            <li role="presentation">
                                                <a href="{% url 'simple_risk_accept_debt_item' debt_item.id %}?return_url={{ request.get_full_path|urlencode }}">
                                                    <i class="fa-solid fa-circle-exclamation"></i> Accept Risk
                                                </a>
                                            </li>
                                        {% endif %}
                                        {% if debt_item.debt_test.debt_engagement.debt_context.enable_full_risk_acceptance %}
                                        <li role="presentation">
                                            <a href ="{% url 'add_risk_acceptance' debt_item.debt_test.debt_engagement.id debt_item.id %}?return_url={{ request.get_full_path|urlencode }}">
                                                <i class="fa-solid fa-circle-exclamation"></i> Add Risk Acceptance...
                                            </a>
                                        </li>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                            <li role="presentation">
                                <a href="{% url 'action_history' debt_item|content_type debt_item.id %}">
                                    <i class="fa-solid fa-clock-rotate-left"></i> View History
                                </a>
                            </li>
                            {% if debt_item|has_object_permission:"Debt_Item_Delete" %}
                                <li role="separator" class="divider"></li>
                                <li role="presentation">
                                    <a class="text-danger delete-debt_item" href="#">
                                        <i class="fa-solid fa-trash"></i> Delete Debt_Item
                                    </a>
                                </li>
                                <form id="delete-debt_item-form" method="post" action="{% url 'delete_debt_item' debt_item.id %}">
                                    {% csrf_token %}
                                    <input type="hidden" label="delete_debt_item" aria-label="delete_debt_item" name="id" value="{{ debt_item.id }}"/>
                                </form>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
            </div>
        </div>
        <div class="table-responsive">
            <table id="notes" class="table-striped table table-condensed table-hover centered">
                {% if debt_item.under_review %}
                    <tr class="bg-warning">
                        <th class="bg-warning" colspan="7">
                            <span class="text-danger">
                                <i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i>
                                Alert: This Debt_Item is under review and may not be 100% accurate.
                            </span>
                            {% if debt_item|has_object_permission:"Debt_Item_Edit" and clear_peer_review %}
                                [<a title="Clear Review" class="text-primary" style="display: inline !important;"
                                    href="{% url 'clear_debt_item_review' debt_item.id %}">Clear Review</a>]
                            {% endif %}
                        </th>
                    </tr>
                {% endif %}
                {% if debt_item.under_defect_review %}
                    <tr class="bg-warning">
                        <th class="bg-warning" colspan="7">
                            <span class="text-danger">
                                <i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i>
                                Alert: Please review this debt_item to verify if the defect is remediated.
                            </span>
                            [<a title="Review Debt_Item for Closure" class="text-primary"
                                style="display: inline !important;"
                                href="{% url 'defect_debt_item_review' debt_item.id %}">Review Debt_Item for Closure</a>]
                        </th>
                    </tr>
                {% endif %}
                <tr>
                    {% block header_head %}
                        <th>ID</th>
                        <th>Severity</th>
                        {% if system_settings.enable_debt_item_sla %}
                        <th>SLA</th>
                        {% endif %}
                        {% if debt_item.scanner_confidence %}
                        <th>Scanner Confidence</th>
                        {% endif %}
                        <th>Status</th>
                        {% if debt_item.risk_acceptance_set.all %}
                            <th>Risk Acceptance</th>
                        {% endif %}
                        {% if debt_item.duplicate_debt_item %}
                        <th>Original</th>
                        {% endif %}
                        {% if duplicate_cluster and not debt_item.duplicate %}
                            <th title="Debt_Items that are marked as duplicate of this debt_item">Duplicates</th>
                        {% elif duplicate_cluster and debt_item.duplicate %}
                            <th title="Debt_Items that are also marked as duplicates of the same original debt_item">Duplicate Cluster</th>
                        {% endif %}
                        <!--<th>Type</th>-->
                        <th>Date discovered</th>
                        <th>Age</th>
                        {% if debt_item.publish_date %}
                            <th>Vuln Publish date</th>
                        {% endif %}
                        {% if debt_item.planned_remediation_date %}
                            <th>Planned Remediation</th>
                        {% endif%}
                        {% if debt_item.planned_remediation_version %}
                            <th>{% trans "Planned Remediation version" %}</th>
                        {% endif %}
                        <th>Reporter</th>
                        {% if debt_item.mitigated %}
                            <th>Date Mitigated</th>
                            <th>Mitigated By</th>
                        {% endif %}
                            <!--<th>CWE</th>
                            <th>Vulnerability Id</th>
                        <th>Found by</th>-->
                    {% endblock header_head %}
                </tr>
                <tr>
                    {% block header_body %}
                        <td title="hash_code: {{ debt_item.hash_code }}">{{ debt_item.id }}</td>
                        <td>
                            <span class="label severity severity-{{ debt_item.severity }}">
                                {% if debt_item.severity %}
                                    {% if debt_item.cvssv3 %}
                                        <i class="no-italics has-popover" font-style="normal" data-toggle="tooltip" data-placement="bottom" data-container="body" title="" href="#"
                                            data-content="{{ debt_item.cvssv3 }}">
                                    {% endif %}
                                    {{ debt_item.severity_display }}
                                    {% if debt_item.cvssv3_score %}
                                        ({{ debt_item.cvssv3_score }})
                                    {% endif %}
                                    {% if debt_item.cvssv3 %}
                                        </i>
                                    {% endif %}
                                {% else %}
                                    Unknown
                                {% endif %}
                            </span>
                        </td>
                        {% if system_settings.enable_debt_item_sla %}
                        <td>
                        {{ debt_item|debt_item_sla }}
                        </td>
                        {% endif %}
                        {% if debt_item.scanner_confidence %}
                        <td> {{debt_item.get_scanner_confidence_text}}</td>
                        {% endif %}
                        <td class="nowrap, align-top">
                                {% comment %}
                                {% if debt_item.duplicate %}
                                    {% include "dojo/debt_item_related_actions.html" with similar_debt_item=debt_item debt_item_context=debt_item intro=debt_item|debt_item_display_status|safe %}
                                {% else %}
                                    {{ debt_item|debt_item_display_status|safe }}
                                {% endif %}
                                {% endcomment %}
                                {{ debt_item|debt_item_display_status|safe }}
                            &nbsp;{{ debt_item|debt_import_history }}
                        </td>
                        {% if debt_item.risk_acceptance_set.all %}
                            <td>
                                {% for ra in debt_item.risk_acceptance_set.all|slice:":5" %}
                                    <a href="{% url 'view_risk_acceptance' debt_item.debt_test.debt_engagement.id ra.id %}"
                                    class="fa-solid fa-circle-exclamation fa-lg has-popover {% if ra.is_expired %}lightgrey{% endif%}"
                                    data-trigger="hover" data-placement="right"
                                    data-content="{{ ra.name_and_expiration_info }}"
                                    data-container="body" data-original-title="Risk Acceptance"></a>
                                {% endfor %}
                            </td>
                        {% endif %}
                        {% if debt_item.duplicate_debt_item %}
                            <td>
                                <div class="align-top">
                                    <div class="dropdown">
                                        <a class="fa-solid fa-bug" href="{% url 'view_debt_item' debt_item.duplicate_debt_item.id %}" title="{{ debt_item.duplicate_debt_item|debt_item_extended_title }}"/>

                                        <a href="#" data-toggle="dropdown">&nbsp;<i class="fa-solid fa-ellipsis-vertical"></i>&nbsp;</a>
                                        <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
                                        <li>
                                            <a class="" href="{% url 'view_debt_item' debt_item.duplicate_debt_item.id %}">
                                            <i class="fa-solid fa-bug" title="valentino"></i> {{ debt_item.duplicate_debt_item|debt_item_extended_title }}
                                            </a>
                                        </li>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        {% endif %}
                        {% if duplicate_cluster %}
                        <td>
                            <div class="align-top">
                                <div class="dropdown">
                                    {% for duplicate in duplicate_cluster|slice:"5" %}
                                        <a class="fa-solid fa-bug" href="{% url 'view_debt_item' duplicate.id %}" title="{{ duplicate|debt_item_extended_title }}"/>
                                    {%  endfor %}
                                    {% if duplicate_cluster|length > 5 %}
                                        <a href="#duplicate_cluster" onclick="$('#duplicate_tree_toggle').click()">...</a>
                                    {% endif %}
                                    <a href="#" data-toggle="dropdown">&nbsp;<i class="fa-solid fa-ellipsis-vertical"></i>&nbsp;</a>
                                    <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
                                    {% for duplicate in duplicate_cluster|slice:"5" %}
                                        <li>
                                            <a class="" href="{% url 'view_debt_item' duplicate.id %}">
                                            <i class="fa-solid fa-bug"></i> {{ duplicate|debt_item_extended_title }}
                                            </a>
                                        </li>
                                    {%  endfor %}
                                    {% if duplicate_cluster|length > 5 %}
                                        <li>
                                            <a href="#duplicate_cluster" onclick="$('#duplicate_tree_toggle').click()">
                                            <i class="fa-solid fa-bug"></i>... more below ...</i>
                                            </a>
                                        </li>
                                    {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </td>
                        {% endif %}
                        <!--<td>
                            {% if debt_item.static_debt_item and debt_item.dynamic_debt_item > 0 %}
                                Static/Dynamic
                            {% elif debt_item.static_debt_item > 0 %}
                                Static
                            {% else %}
                                Dynamic
                            {% endif %}
                        </td>-->
                        <td>{{ debt_item.date }}</td>
                        <td>{{ debt_item.age }} days</td>
                        {% if debt_item.publish_date %}
                            <td>{{ debt_item.publish_date }}</td>
                        {% endif %}
                        {% if debt_item.planned_remediation_date %}
                            <td>{{ debt_item.planned_remediation_date }}</td>
                        {% endif %}
                        {% if debt_item.planned_remediation_version %}
                            <td>{{ debt_item.planned_remediation_version }}</td>
                        {% endif %}
                        <td>{{ debt_item.reporter }}</td>
                        {% if debt_item.mitigated %}
                            <td>{{ debt_item.mitigated }}</td>
                            <td>{{ debt_item.mitigated_by }}</td>
                        {% endif %}
                        <!--<td>
                        {% if debt_item.cwe > 0 %}
                            <a target="_blank" href="{{ debt_item.cwe|cwe_url }}">
                                <i class="fa-solid fa-arrow-up-right-from-square"></i> {{ debt_item.cwe }}
                            </a>
                        {% endif %}
                        </td>-->
                        <!--<td>
                        {% with debt_item|first_vulnerability_id as first_vulnerability_id %}
                        {% if first_vulnerability_id %}
                            {% if first_vulnerability_id|has_vulnerability_url %}
                                <a target="_blank" href="{{ first_vulnerability_id|vulnerability_url }}">
                                    <i class="fa-solid fa-arrow-up-right-from-square"></i> {{ first_vulnerability_id }}
                                </a>
                            {% else %}
                                {{ first_vulnerability_id }}
                            {% endif %}
                        {% endif %}
                        </td>-->
                        <!--<td> {% for scanner in found_by %}
                            {{ scanner }}
                        {% endfor %}</td>-->
                        {% endwith %}
                    {% endblock header_body %}
                </tr>
            </table>
        </div>
    </div>

    {% with debt_item|additional_vulnerability_ids as additional_vulnerability_ids %}
    {% if additional_vulnerability_ids %}
    <div class="panel panel-default">
        <table id="additional_debt_item_references" class="table-striped table table-condensed table-hover centered">
            <tr>
                <th>Additional Vulnerability Ids</th>
            </tr>
            <tr>
                <td>
                    {% for vulnerability_id in additional_vulnerability_ids %}
                        {% if vulnerability_id|has_vulnerability_url%}
                            <a target="_blank" href="{{ vulnerability_id|vulnerability_url }}">
                                <i class="fa-solid fa-arrow-up-right-from-square"></i> {{ vulnerability_id }}</a>
                        {% else %}
                            {{ vulnerability_id }}
                        {% endif %}
                        {% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </td>
            </tr>
        </table>
    </div>
    {% endif %}
    {% endwith %}</td>

    {% if debt_item.static_debt_item or debt_item.line > 0 %}
        {% if debt_item.sast_source_object or debt_item.sast_sink_object or debt_item.sast_source_file_path or debt_item.sast_source_line > 0 %}
        {# For tools that give information on both source (start) and sink (end) of the attack vector #}

        <div class="panel panel-default">
            <table id="sast_source" class="table-striped table table-condensed table-hover centered">
                <tr>
                    <th>Source Filepath</th>
                    <th>Source Line Number</th>
                    <th>Source Object</th>
                </tr>
                <tr>
                    <td>
                        <span>
                            {{ debt_item.get_sast_source_file_path_with_link|safe }}
                        </span>
                    </td>
                    <td>
                        <span>
                           {{ debt_item.sast_source_line }}
                        </span>
                    </td>
                    <td>
                        <span>
                           {{ debt_item.sast_source_object }}
                        </span>
                    </td>
                </tr>
            </table>
        </div>
        <div class="panel panel-default">
            <table id="sast_sink" class="table-striped table table-condensed table-hover centered">
                <tr>
                    <th>Sink Filepath</th>
                    <th>Sink Line Number</th>
                    <th>Sink Object</th>
                </tr>
                <tr>
                    <td>
                        <span>
                            {{ debt_item.get_file_path_with_link|safe }}
                        </span>
                    </td>
                    <td>
                        <span>
                           {{ debt_item.line }}
                        </span>
                    </td>
                    <td>
                        <span>
                           {{ debt_item.sast_sink_object }}
                        </span>
                    </td>
                </tr>
            </table>
        </div>
        {% endif %}
    {% endif %}
    {% if debt_item.service or debt_item.file_path or debt_item.line > 0 or debt_item.has_jira_configured or debt_item.has_jira_issue or debt_item.github_issue or debt_item.github_conf_new or debt_item.debt_item_group or debt_item.component_name or debt_item.nb_occurences > 1 %}
    <div class="panel panel-default">
        <table id="error_notes" class="table-striped table table-condensed table-hover centered">
            <tr>
                {% if debt_item.service %}
                <th>Service</th>
                {% endif %}
                {% if debt_item.file_path %}
                <th>Location</th>
                {% endif %}
                {% if debt_item.line %}
                <th>Line Number</th>
                {% endif %}
                {% if debt_item.nb_occurences > 1 %}
                <th>Nb occurences</th>
                {% endif %}
                {% if debt_item.component_name %}
                <th>Component Name</th>
                {% endif %}
                {% if debt_item.component_version %}
                <th>Component Version</th>
                {% endif %}
                {% if debt_item.has_jira_configured or debt_item.jira_issue %}
                <th>JIRA</th>
                <th>JIRA Change</th>
                {% endif %}
                {% if debt_item.github_conf_new or debt_item.github_issue %}
                <th>GitHub</th>
                {% endif %}
                {% if 'is_debt_item_groups_enabled'|system_setting_enabled and debt_item.debt_item_group %}
                <th>Group</th>
                {% endif %}
                {% if debt_item.effort_for_fixing %}
                <th>{% trans "Effort for fixing" %}</th>
                {% endif %}
            </tr>
            <tr>
                {% if debt_item.service %}
                <td>
                    <span>
                        {{ debt_item.service }}
                    </span>
                </td>
                {% endif %}
                {% if debt_item.file_path %}
                <td>
                    <span>
                        {{ debt_item.get_file_path_with_link|safe }}
                        <i class="fa-solid fa-copy fa-align-right copytoclipboard" title="copy to clipboard"
                        data-clipboard-text="{{debt_item.file_path}}"></i>
                    </span>
                </td>
                {% endif %}
                {% if debt_item.line %}
                <td>
                    <span>
                        {{ debt_item.line }}
                    </span>
                </td>
                {% endif %}
                {% if debt_item.nb_occurences > 1 %}
                <td>
                    <span>
                        {{ debt_item.nb_occurences }}
                    </span>
                </td>
                {% endif %}
                {% if debt_item.component_name %}
                <td>
                    <span>
                        {{ debt_item.component_name }}
                    </span>
                </td>
                {% endif %}
                {% if debt_item.component_version %}
                <td>
                    <span>
                        {{ debt_item.component_version }}
                    </span>
                </td>
                {% endif %}
                {% if debt_item.has_jira_configured or debt_item.has_jira_issue or debt_item.has_jira_group_issue %}
                    <td id="jira">
                        {% if debt_item.has_jira_group_issue %}
                            <a href="{{ debt_item.debt_item_group | jira_issue_url }}"
                            target="_blank" title="{{ debt_item.debt_item_group | jira_issue_url }} (group)">{{ debt_item.debt_item_group | jira_key }}</a>
                        {% endif %}
                        {% if debt_item.has_jira_issue %}
                            <a href="{{ debt_item | jira_issue_url }}"
                            target="_blank" title="{{ debt_item | jira_issue_url }}">{{ debt_item | jira_key }}</a>
                            <i id="unlink_jira" class="fa-solid fa-trash" title="Unlink JIRA issue from this debt_item."></i>
                            <i id="push_to_jira" class="fa-solid fa-share-from-square" title="Push debt_item data to linked JIRA issue."></i>
                        {% else %}
                            {% if can_be_pushed_to_jira %}
                                {% if not debt_item.has_jira_group_issue %}
                                None
                                <i id="push_to_jira" class="fa-solid fa-share-from-square" title="Create JIRA issue for this debt_item"></i>
                                {% comment %} <a href="{% url 'debt_item_link_to_jira' debt_item.id %}" title="Link existing JIRA issue to debt_item.">
                                    <i class="fa-solid fa-asterisk" title="Link existing JIRA issue to debt_item."></i>
                                </a> {% endcomment %}
                                {% endif %}
                            {% else %}
                                <i class="fa-solid fa-circle-question has-popover" data-trigger="hover"
                                data-content="{{ can_be_pushed_to_jira_error }}"
                                data-placement="bottom" data-container="body">
                                </i>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td>
                        {% if debt_item.has_jira_group_issue %}
                            <div title="{{ debt_item.debt_item_group.jira_issue.jira_change|date:"DATETIME_FORMAT" }} (group)">{{ debt_item.debt_item_group.jira_issue.jira_change|naturalday }}</div>
                        {% elif debt_item.jira_issue %}
                            <div title="{{ debt_item.jira_issue.jira_change|date:"DATETIME_FORMAT" }}">{{ debt_item.jira_issue.jira_change|naturalday }}</div>
                        {% endif %}
                    </td>
                {% endif %}
                {% if debt_item.github_conf_new or debt_item.github_issue %}
                    <td>
                    {% if debt_item.github_issue %}
                        <a href="{{ debt_item.github_issue.issue_url }}" target="_blank" title="{{ debt_item.github_issue.issue_url }}">#{{ debt_item.github_issue.issue_id }}</a>
                    {% endif %}
                    </td>
                {% endif %}
                {% if 'is_debt_item_groups_enabled'|system_setting_enabled and debt_item.debt_item_group %}
                    <td>
                        <a href="{% url 'view_debt_item_group' debt_item.debt_item_group.id %}" title="{{ debt_item.debt_item_group.name }}">{{ debt_item.debt_item_group.name }}</a>
                        <i id="push_group_to_jira_{{ debt_item.debt_item_group.group.id }}" data-group-id="{{ debt_item.debt_item_group.id }}" class="fa-solid fa-share-from-square push_group_to_jira" title="Update JIRA issue with current data from this group of debt_items."></i>
                    </td>
                {% endif %}
                {% if debt_item.effort_for_fixing %}
                <td>
                    <span>
                        {{ debt_item.effort_for_fixing }}
                    </span>
                </td>
                {% endif %}
            </tr>
        </table>
    </div>
    {% endif %}
    {% if debt_item.param or debt_item.payload %}
        <div class="panel panel-default">
            <table id="error_notes" class="table-striped table table-condensed table-hover">
                <tr>
                    <th>Injected Parameter(s)</th>
                    {% if debt_item.payload %}
                    <th>Payload</th>
                    {% endif %}
                </tr>
                <tr>
                    <td>
                        <span>
                             {{ debt_item.param|default_if_none:"" }}
                        </span>
                    </td>
                    {% if debt_item.payload %}
                    <td>
                        <span>
                             {{ debt_item.payload|default_if_none:"" }}
                        </span>
                    </td>
                    {% endif %}
                </tr>
            </table>
        </div>
    {% endif %}

    {% if debt_item.duplicate_debt_item_set %}
        {% comment %}
            little extra div to serve as anchor, with some padding and padding cancelling margin to make sure it scrolls into view correctly
        {% endcomment %}
        <div id="duplicate_cluster" style="padding-top: 6em; margin-top: -6em;"></div>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4>Duplicate Cluster ({{ debt_item|debt_item_duplicate_cluster_size }})<span class="pull-right"><a data-toggle="collapse" id="duplicate_tree_toggle" href="#duplicate_tree"><i class="glyphicon glyphicon-chevron-down"></i></a></span></h4>
            </div>
            <div id="duplicate_tree" class="panel-body collapse">
                {% if debt_item.duplicate_debt_item %}
                    {% include "dojo/debt_item_related_list.html" with debt_item_context=debt_item debt_item_first_related=debt_item.duplicate_debt_item debt_item_list=duplicate_cluster prefix='duplicate' %}
                {% else %}
                    {% include "dojo/debt_item_related_list.html" with debt_item_context=debt_item debt_item_first_related=debt_item debt_item_list=duplicate_cluster prefix='duplicate' %}
                {% endif %}
            </div>
        </div>
    {% endif %}

        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="has-filters">Similar Debt Items ({{ similar_debt_items.paginator.count }})
                    <i class="fa-solid fa-circle-question has-popover" data-trigger="hover"
                       data-content="Opening this panel shows Debt Items that are not exact duplicates,
                        but have similar values for [TO DO].
                        It has a filter panel where filtering can be made less or more strict, and across
                        Debt Context boundaries. The resulting Debt Items can be view, marked as duplicate or original.
                        Clear filters will empty all filters. Restart will start over by matching against the fields
                        mentioned above."
                        data-placement="bottom" data-container="body">
                    </i>
                    <span class="pull-right">
                        <button id="show-filters" data-toggle="collapse" data-target="#the-filters-wrapper" class="btn btn-primary toggle-filters"> <i class="fa-solid fa-filter"></i> <i class="caret"></i> </button>
                        &nbsp;
                        <a data-toggle="collapse" href="#the-filters-wrapper"><i class="glyphicon glyphicon-chevron-down"></i></a>
                    </span>
                </h4>
            </div>
            <span id="the-filters-wrapper" class="collapse {% if similar_debt_items_filter.has_changed %}in{% endif %}">
                <div id="the-filters" class="is-filters panel-body similar-filters">
                    {% url 'view_debt_item' debt_item.id as debt_item_url %}
                    {% include "dojo/filter_snippet.html" with form=similar_debt_items_filter.form form_id="similar" clear_js=True restart_link=debt_item_url %}
                </div>
                {% if similar_debt_items_filter %}
                    <div id="similar_debt_items" class="panel-body">
                        {% include "dojo/debt_item_related_list.html" with debt_item_context=debt_item debt_item_list=similar_debt_items prefix='similar' %}
                    </div>
                {% endif %}
            </span>
        </div>

    {% comment %} Add a form to (ab)use to submit any actions related to similar/duplicates as POST requests {% endcomment %}
    <form method="post" style="display: none" id="related_action">
        {% csrf_token %}
        <input type="hidden" name="return_url" value="{{ request.get_full_path }}" />
    </form>

    <div class="hidden" style="padding-bottom: 5px;" id="bulk_edit_menu">
        <div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">
            <div class="btn-group mr-2" role="group" aria-label="Second group">
                <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="dropdownMenu2"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                    Bulk Edit
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenu1" id="bulk_edit">
                    <li style="padding-left: 8px;">
                        <form action="{% url 'endpoints_status_bulk' debt_item.id %}" method="post" id="bulk_change_form">
                            {% csrf_token %}
                            <input type="hidden" name="return_url" value="{{ request.get_full_path }}" />
                            <label style="font-size: 80%; font-weight: normal; display: block">
                                <input id="id_bulk_active" label="active "name="active" type="checkbox"/>
                                <span>Active</span>
                            </label>
                            <label style="font-size: 80%; font-weight: normal; display: block">
                                <input id="id_bulk_false_p" label="false_positive" name="false_positive" type="checkbox"/>
                                <span>False Positive</span>
                            </label>
                            <label style="font-size: 80%; font-weight: normal; display: block">
                                <input id="id_bulk_out_of_scope" label="out_of_scope" name="out_of_scope" type="checkbox"/>
                                <span>Out of scope</span>
                            </label>
                            <label style="font-size: 80%; font-weight: normal; display: block">
                                <input id="id_bulk_mitigated" label="mitigated" name="mitigated" type="checkbox"/>
                                <span>Mitigated</span>
                            </label>
                            <label style="font-size: 80%; font-weight: normal; display: block">
                                <input id="id_bulk_risk_accepted" label="risk_accepted" name="risk_accepted" type="checkbox"/>
                                <span>Risk Accepted</span>
                            </label>
                            <br/>
                            <input type="submit" class="btn btn-sm btn-primary" label="Submit" name="Submit" value="Submit"/>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!--Import History begin -->
    {% if 'TRACK_IMPORT_HISTORY'|setting_enabled and debt_test_import_debt_item_action %}
        <div class="panel panel-default collapse in">
            <div class="panel-heading">
                <div class="clearfix">
                    <h4 class="has-filters">
                        {% trans "Import History" %} ({{ debt_test_import_debt_item_actions_count }})
                        <i class="fa-solid fa-circle-question has-popover"
                        data-trigger="hover"
                        data-content="List of imports/reimports that created/closed/reactivated this debt_item in any debt_test."
                        data-placement="right"
                        data-container="body"
                        data-original-title=""
                        title="">
                        </i>
                        <div class="dropdown pull-right">
                            <button id="show-filters"
                                    data-toggle="collapse"
                                    data-target="#import-history-filters"
                                    class="btn btn-primary toggle-filters">
                                <i class="fa-solid fa-filter"></i> <i class="caret"></i>
                            </button>
                            &nbsp;
                            <span class="pull-right">
                                <a data-toggle="collapse" href="#debt_import_history">
                                    <i class="glyphicon glyphicon-chevron-down"></i>
                                </a>
                            </span>
                        </div>
                    </h4>
                </div>
            </div>
            <div id="import-history-filters" class="is-filters panel-body collapse">
                {% include "dojo/filter_snippet.html" with form=debt_test_import_filter.form %}
                {% include "dojo/filter_snippet.html" with form=debt_test_import_debt_item_action_filter.form %}
            </div>
            <div id="debt_import_history" class="panel panel-body table-responsive collapse">
                {% if paged_debt_test_import_debt_item_actions %}
                    <table class="table-striped tablesorter-bootstrap table table-hover centered">
                        <thead>
                            <tr>
                                <th>{% trans "Action" %}</th>
                                <th>{% trans "Date/Time" %}</th>
                                <th>{% trans "Import Type" %}</th>
                                <th>{% trans "Branch/Tag" %}</th>
                                <th>{% trans "Build ID" %}</th>
                                <th>{% trans "Commit" %}</th>
                                <th>{% trans "Version" %}</th>
                                <th>{% trans "Endpoint" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for debt_test_import_debt_item_action in paged_debt_test_import_debt_item_actions %}
                                <tr>
                                    <td>
                                        {{ debt_test_import_debt_item_action.get_action_display }}
                                    </td>
                                    <td>
                                        <a href="{% url 'debt_engagement_all_debt_items' debt_test_import_debt_item_action.debt_test_import.debt_test.debt_engagement.id %}?debt_test_import_debt_item_action__debt_test_import={{ debt_test_import_debt_item_action.debt_test_import.id }}">
                                            {{ debt_test_import_debt_item_action.debt_test_import.created|date:"DATETIME_FORMAT" }}
                                        </a>
                                        {{ debt_test_import_debt_item_action.debt_test_import|import_settings_tag }}
                                    </td>
                                    <td>
                                        {{ debt_test_import_debt_item_action.debt_test_import.type }}
                                    </td>
                                    <td>
                                        {{ debt_test_import_debt_item_action.debt_test_import.branch_tag|default_if_none:"" }}
                                    </td>
                                    <td>
                                        {{ debt_test_import_debt_item_action.debt_test_import.build_id|default_if_none:"" }}
                                    </td>
                                    <td>
                                        {{ debt_test_import_debt_item_action.debt_test_import.commit_hash|default_if_none:"" }}
                                    </td>
                                    <td>
                                        {{ debt_test_import_debt_item_action.debt_test_import.version|default_if_none:"" }}
                                    </td>
                                    <td>
                                        {{ debt_test_import_debt_item_action.debt_test_import.import_settings.endpoint|default_if_none:"" }}
                                    </td>

                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="panel-body">
                        <p class="text-center">
                            {% trans "No import history found." %}
                        </p>
                    </div>
                {% endif %}
                <div class="clearfix">
                    {% include "dojo/paging_snippet.html" with page=paged_debt_test_import_debt_item_actions prefix='debt_test_import_debt_item_actions' page_size=True %}
                </div>
            </div>
        </div>
    {% endif %}
    <!--Import activity end -->

    {% include "dojo/snippets/debt_endpoints.html" with debt_item=debt_item destination="UI" %}

    <div class="view-debt_item">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4>Description <span class="pull-right"><a data-toggle="collapse" href="#vuln_desc"><i
                        class="glyphicon glyphicon-chevron-up"></i></a></span></h4>
            </div>
            <div id="vuln_desc" class="panel-body debt_item-description collapse in">
              <pre>{{ debt_item.description|markdown_render|default_if_none:"" }}</pre>
            </div>
        </div>

        {% if files %}
            <div class="row">
                <div class="col-md-12" id="cred">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4>Files<span class="pull-right">
                            <a data-toggle="collapse" href="#add_feat_files">
                                <i class="glyphicon glyphicon-chevron-down"></i></a></span>
                            <a title="Manage Files" name="Manage Files" class="btn btn-sm btn-primary pull-right"
                                href="{% url 'manage_files' oid=debt_item.id obj_type='Debt_Item' %}">
                                <span class="fa-solid fa-pen-to-square"></span></a>
                            </h4>
                        </div>

                        <div id="add_feat_files" class="panel-body collapse {% if files %}in{% endif %}">
                            {% for file in files %}
                            <div class="col-md-2" style="text-align: center">
                                <div class="row">
                                    {% url 'access_file' fid=file.id oid=debt_item.id obj_type='Debt_Item' as image_url %}
                                    <a href="{{ image_url }}" target="_blank">
                                        {% if file|get_thumbnail %}
                                            <img src="{{ image_url }}" alt="thumbnail" style="width:150px">
                                        {% else %}
                                            <span style="font-size: 50px;" class="glyphicon glyphicon-file"></span>
                                        {% endif %}
                                    </a>
                                </div>
                                <div class="row">
                                    <caption style="text-align:center">{{ file.title }}</caption>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4>Impact <span class="pull-right"><a data-toggle="collapse" href="#vuln_impact"><i
                        class="glyphicon glyphicon-chevron-{% if debt_item.impact %}up{%else%}down{%endif%}"></i></a></span></h4>
            </div>
            <div id="vuln_impact" class="panel-body collapse {% if debt_item.impact %}in{%endif%}">
                <pre>{{ debt_item.impact|markdown_render|default_if_none:"" }}</pre>
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4>Mitigation <span class="pull-right"><a data-toggle="collapse" href="#vuln_mitigation"><i
                        class="glyphicon glyphicon-chevron-{% if debt_item.mitigation %}up{%else%}down{%endif%}"></i></a></span></h4>
            </div>
            <div id="vuln_mitigation" class="panel-body collapse {% if debt_item.mitigation %}in{%endif%}">
                <pre>{{ debt_item.mitigation|markdown_render|default_if_none:"" }}</pre>
            </div>
        </div>
        {% if debt_item.burprawrequestresponse_set.all %}
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4>Request / Response Pairs <span class="pull-right"><a data-toggle="collapse" href="#vuln_req_res">
                        <i class="glyphicon glyphicon-chevron-down"></i></a></span></h4>
                </div>
                <div id="vuln_req_res" class="panel-body collapse">
                    {% for req_resp in debt_item.burprawrequestresponse_set.all %}
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h4>Request #{{ forloop.counter }}<span class="pull-right">
                                    <a data-toggle="collapse" href="#vuln_req_{{ forloop.counter }}">
                                        <i class="glyphicon glyphicon-chevron-down"></i></a></span></h4>
                            </div>
                            <div id="vuln_req_{{ forloop.counter }}" class="panel-body collapse">
                                <pre>{{ req_resp.get_request }}</pre>
                            </div>
                        </div>
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h4>Response #{{ forloop.counter }}<span class="pull-right">
                                    <a data-toggle="collapse" href="#vuln_res_{{ forloop.counter }}">
                                        <i class="glyphicon glyphicon-chevron-down"></i></a></span></h4>
                            </div>

                            <div id="vuln_res_{{ forloop.counter }}" class="panel-body collapse">
                                <pre>{{ req_resp.get_response }}</pre>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <!--<div class="panel panel-default" id="steps">
            <div class="panel-heading">
                <h4>Steps To Reproduce <span class="pull-right"><a data-toggle="collapse" href="#vuln_reproduce"><i
                        class="glyphicon glyphicon-chevron-{% if debt_item.steps_to_reproduce %}up{%else%}down{%endif%}"></i></a></span></h4>
            </div>
            <div id="vuln_reproduce" class="panel-body collapse {% if debt_item.steps_to_reproduce %}in{%endif%}">
                <pre>{{ debt_item.steps_to_reproduce|markdown_render|default_if_none:"" }}</pre>
            </div>
        </div>-->

        <!--<div class="panel panel-default">
            <div class="panel-heading">
                <h4>Severity Justification <span class="pull-right"><a data-toggle="collapse" href="#sev_just"><i
                        class="glyphicon glyphicon-chevron-{% if debt_item.severity_justification %}up{%else%}down{%endif%}"></i></a></span></h4>
            </div>
            <div id="sev_just" class="panel-body collapse {% if debt_item.severity_justification %}in{%endif%}">
                <pre>{{ debt_item.severity_justification|markdown_render|default_if_none:"" }}</pre>
            </div>
        </div>-->

        <!--<div class="panel panel-default">
            <div class="panel-heading">
                <h4>References <span class="pull-right"><a data-toggle="collapse" href="#vuln_refs"><i
                        class="glyphicon glyphicon-chevron-{% if debt_item.references %}up{%else%}down{%endif%}"></i></a></span></h4>
            </div>
            <div id="vuln_refs" class="panel-body collapse {% if debt_item.references %}in{%endif%}">
                <pre>{{ debt_item.get_references_with_links|markdown_render|default_if_none:"" }}</pre>
            </div>
        </div>-->

        <!--Cred Begin-->
        <!--{% if  debt_item.static_debt_item != True and system_settings.enable_credentials %}
            <div class="row">
                <div class="col-md-12" id="cred">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4>Credential
                                {% if not cred_debt_item and debt_item|has_object_permission:"Debt_Item_Edit" %}
                                    {% if cred_debt_engagement or creds %}
                                        <a title="Add New Credential" class="pull-right btn btn-primary btn-sm"
                                           href="{% url 'new_cred_debt_item' debt_item.id %}"><span
                                                class="fa-solid fa-plus"></span></a>
                                    {% endif %}
                                {% endif %}
                            </h4>
                        </div>
                        {% if cred_debt_item or creds %}
                            <table class="tablesorter-bootstrap table table-condensed table-striped table-hover">
                                <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Environment</th>
                                    <th>Authentication Provider</th>
                                    <th>Login Valid</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% if cred_debt_item %}
                                    <tr>
                                        <td colspan="7">
                                            Credential Configured for this <strong>Debt_Item</strong>
                                            {% if not cred_debt_item %}
                                                <br/>
                                                <center>None configured</center>
                                            {% endif %}
                                        </td>
                                    </tr>

                                    {% for cred in cred_debt_item %}
                                        <tr>
                                            <td>
                                                <a href="{{ cred.cred_id.url }}"
                                                   target="_blank">{{ cred.cred_id.name }}</a>
                                            </td>
                                            <td>{{ cred.cred_id.username }}</td>
                                            <td>{{ cred.cred_id.role }}</td>
                                            <td>{{ cred.cred_id.environment }}</td>
                                            <td>{{ cred.is_authn_provider }}</td>
                                            <td>{{ cred.cred_id.is_valid }}</td>
                                            <td>
                                                <div class="btn-group">
                                                    {% if user.is_superuser %}
                                                    <a class="btn btn-sm btn-secondary"
                                                       href="{% url 'view_cred_debt_item' cred.debt_item.id cred.id %}">View</a>
                                                    {% endif %}
                                                    {% if debt_item|has_object_permission:"Debt_Item_Edit" %}
                                                    <a class="btn btn-sm btn-danger delete"
                                                       href="{% url 'delete_cred_debt_item' cred.debt_item.id cred.id %}">Delete</a>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% endif %}
                                {% if not cred_debt_item %}
                                    <tr>
                                        <td colspan="7">
                                            Credentials Inherited from <strong>Debt_Test: {{ debt_item.debt_test }}</strong>
                                        </td>
                                    </tr>
                                    {% for cred in creds %}
                                        <tr>
                                            <td>
                                                <a href="{{ cred.cred_id.url }}"
                                                   target="_blank">{{ cred.cred_id.name }}</a>
                                            </td>
                                            <td>{{ cred.cred_id.username }}</td>
                                            <td>{{ cred.cred_id.role }}</td>
                                            <td>{{ cred.cred_id.environment }}</td>
                                            <td>{{ cred.is_authn_provider }}</td>
                                            <td>{{ cred.cred_id.is_valid }}</td>
                                            <td>
                                                <div class="btn-group">
                                                    <a class="btn btn-sm btn-primary"
                                                       href="{% url 'view_cred_debt_engagement_debt_test' cred.debt_test.id cred.id %}">View</a>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% endif %}


                                </tbody>
                            </table>
                        {% else %}
                            <div class="panel-body">
                                <p>No credentials configured.
                                    {% if not cred_debt_engagement %}
                                        Configure debt_engagement credentials first, then add a credential to the debt_test or
                                        debt_item.
                                    {% endif %}
                                </p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>-->
            <!--Cred end -->
        {% endif %}
    </div>

    {% include "dojo/snippets/sonarqube_history.html" with debt_item=debt_item only %}

    {% include "dojo/snippets/comments.html" with notes=notes object=debt_item destination="debt_item" %}

    <div class="PrevAndNext_Buttons">
    </div>

    <div class="protip">
       <i class="fa-solid fa-lightbulb"></i> <strong>ProTip!</strong> Type <kbd>e</kbd> to edit any Debt Item, <kbd>p</kbd> and <kbd>n</kbd> to navigate to the previous or next Debt Item.
    </div>
{% endblock %}
{% block postscript %}
    {{ block.super }}
    <script src="{% static "clipboard/dist/clipboard.min.js" %}"></script>
    <script type="application/javascript" src="{% static "jquery.hotkeys/jquery.hotkeys.js" %}"></script>
    <script type="text/javascript" src="{% static "jquery-highlight/jquery.highlight.js" %}"></script>
    <script type="text/javascript">
        var firstID = {{debt_items_list.0}};
        var currentID = {{debt_item.id}};
        var lastID = {{debt_items_list_lastElement}};
        if(currentID != firstID)
        {
            $('.PrevAndNext_Buttons').append('<a href="{% url 'view_debt_item' prev_debt_item_id %}" class="btn btn-primary">Previous Debt Item</a> ');
        }
        if(currentID != lastID)
        {
            $('.PrevAndNext_Buttons').append('<a href="{% url 'view_debt_item' next_debt_item_id %}" class="btn btn-primary">Next Debt Item</a>');
        }
        //Ensures dropdown has proper zindex
        $('.table-responsive').on('show.bs.dropdown', function () {
          $('.table-responsive').css( "overflow", "inherit" );
        });
        if (document.referrer.indexOf('simple_search') > 0) {
            var terms = '';
            if ($.cookie('highlight')) {
                terms = $.cookie('highlight').split(' ');

                for (var i = 0; i < terms.length; i++) {
                    $('body').highlight(terms[i]);
                }
            }

            $('input#simple_search').val(terms);
        }

        $(document).ready(function () {
            //Ensures dropdown has proper zindex
            $('.table-responsive').on('show.bs.dropdown', function () {
              $('.table-responsive').css( "overflow", "inherit" );
            });

            $('.table-responsive').on('hide.bs.dropdown', function () {
              $('.table-responsive').css( "overflow", "auto" );
            })
            $("a[data-toggle='collapse']").on('click', function () {
                var i = $($(this).find('i').get(0));
                i.toggleClass('glyphicon-chevron-up').toggleClass('glyphicon-chevron-down');
            })
        });

        // keyboard shortcuts
        $(document).on('keypress', null, 'e', function () {
            window.location.assign('{% url 'edit_debt_item' debt_item.id %}');
        });

        $(document).on('keypress', null, 'p', function () {
            window.location.assign('{% url 'view_debt_item' prev_debt_item_id %}');
        });

        $(document).on('keypress', null, 'n', function () {
            window.location.assign('{% url 'view_debt_item' next_debt_item_id %}');
        });

        $('a.delete-debt_item').on('click', function (e) {
            if (confirm('Are you sure you want to delete this debt_item?')) {
                $("form#delete-debt_item-form").submit();
            }

        });

        $('a.apply-cwe-debt_item').on('click', function (e) {
            if (confirm('Apply CWE template to this debt_item? (This will overwrite mitigation, impact and references.)')) {
                $("form#apply-cwe-debt_item-form").submit();
            }

        });

        $("a#next").on('click', function (e) {
            e.preventDefault();
            var showing = $("img#to_replace").attr('src');
            var thumbnails = $('a.thumbnail');

            thumbnails.each(function (index) {
                if ($(this).data('imageurl') == showing) {
                    console.log(index, thumbnails.length)
                    if (index == thumbnails.length - 1) {
                        // at the end
                        $("img#to_replace").attr('src', $(thumbnails[0]).data('imageurl'));
                        $("#caption_to_replace").html($(thumbnails[0]).data('caption'));
                    }
                    else {
                        $("img#to_replace").attr('src', $(thumbnails[index + 1]).data('imageurl'));
                        $("#caption_to_replace").html($(thumbnails[index + 1]).data('caption'));
                    }
                }
            });
        });

        function jira_action(elem, url) {
            $(elem).removeClass().addClass('fa-solid fa-spin fa-spinner')

            $.ajax({
                type: "post",
                dataType:'json',
                data: '',
                context: this,
                url: url,
                // The ``X-CSRFToken`` evidently can't be set in the
                // ``headers`` option, so force it here.
                // This method requires jQuery 1.5+.
                beforeSend: function (jqXHR, settings) {
                    // Pull the token out of the DOM.
                    jqXHR.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
                },
                success: function (data, textStatus, jqXHR) {
                },
                error: function (request, status, error) {
                    console.log('error')
                    console.log(request.responseText)
                },
                complete: function(e) {
                    location.reload()
                }
            });
        }

        $("#push_to_jira").on('click', function(e) {
            jira_action(this,'{% url 'debt_item_push_to_jira' debt_item.id %}')
        });

        $("#unlink_jira").on('click', function(e) {
            jira_action(this,'{% url 'debt_item_unlink_jira' debt_item.id %}')
        });

        $(".push_group_to_jira").on('click', function(e) {
            jira_action(this, '/debt_item_group/' + this.dataset.groupId + '/jira/push')
        });

        var checkbox_count = 0;
        function get_checkbox_values()
        {
            var checkbox_values_vuln = $("input[type=checkbox][name^='select_vulnerable_']");
            var checkbox_values_rem = $("input[type=checkbox][name^='select_mitigated_']");
            var checkbox_values = Array.from(checkbox_values_vuln).concat(Array.from(checkbox_values_rem));

            return checkbox_values;
        }

        function check_checked_debt_item()
        {
          var checkbox_values = get_checkbox_values();
          for (var i = 0; i < checkbox_values.length; i++) {
            if ($(checkbox_values[i]).prop("checked")) {
              if ((checkbox_values[i].name != 'select_all_vulnerable') || (checkbox_values[i].name != 'select_all_mitigated')) {
                checkbox_count++;
              }
            }
          }
          if (checkbox_count > 0)
          {
              $('div#bulk_edit_menu').removeClass('hidden');
          }
        }

        $(function () {
            check_checked_debt_item();

            // Keep the dropdown menu open for selecting severity status
            $('.dropdown-menu').click(function(e) {
                e.stopPropagation();
            });
            //Ensures dropdown has proper zindex
            $('.table-responsive').on('show.bs.dropdown', function () {
              $('.table-responsive').css( "overflow", "inherit" );
            });

            $('.table-responsive').on('hide.bs.dropdown', function () {
              $('.table-responsive').css( "overflow", "auto" );
            })

            $('#bulk_edit_menu #id_bulk_active').on("click", function (e){
                var checked = this.checked;
                $('#bulk_edit_menu #id_bulk_false_p').prop('disabled', checked);
                $('#bulk_edit_menu #id_bulk_mitigated').prop('disabled', checked);
                $('#bulk_edit_menu #id_bulk_false_p').prop('checked', false);
                $('#bulk_edit_menu #id_bulk_mitigated').prop('checked', false);
            })

            $('#bulk_edit_menu #id_bulk_mitigated').on("click", function (e){
                var checked = this.checked;
                $('#bulk_edit_menu #id_bulk_active').prop('disabled', checked);
                $('#bulk_edit_menu #id_bulk_active').prop('checked', false);
            })

            $('#bulk_edit_menu #id_bulk_false_p').on("click", function (e){
                var checked = this.checked;
                $('#bulk_edit_menu #id_bulk_active').prop('disabled', checked);
                $('#bulk_edit_menu #id_bulk_risk_accepted').prop('disabled', checked);
                $('#bulk_edit_menu #id_bulk_out_of_scope').prop('disabled', checked);
                $('#bulk_edit_menu #id_bulk_active').prop('checked', false);
                $('#bulk_edit_menu #id_bulk_risk_accepted').prop('checked', false);
                $('#bulk_edit_menu #id_bulk_out_of_scope').prop('checked', false);
                $('#bulk_edit_menu #id_bulk_mitigated').prop('checked', checked);
            })

            $('#bulk_edit_menu #id_bulk_risk_accepted').on("click", function (e){
                var checked = this.checked;
                $('#bulk_edit_menu #id_bulk_false_p').prop('disabled', checked);
                $('#bulk_edit_menu #id_bulk_out_of_scope').prop('disabled', checked);
                $('#bulk_edit_menu #id_bulk_false_p').prop('checked', false);
                $('#bulk_edit_menu #id_bulk_out_of_scope').prop('checked', false);
            })

            $('#bulk_edit_menu #id_bulk_out_of_scope').on("click", function (e){
                var checked = this.checked;
                $('#bulk_edit_menu #id_bulk_risk_accepted').prop('disabled', checked);
                $('#bulk_edit_menu #id_bulk_false_p').prop('disabled', checked);
                $('#bulk_edit_menu #id_bulk_risk_accepted').prop('checked', false);
                $('#bulk_edit_menu #id_bulk_false_p').prop('checked', false);
            })

            $('input[type="checkbox"]').change(function () {
              checkbox_count = 0;
              debt_item = $(this).attr("name");
              if (debt_item.indexOf("select_") >= 0)
              {
                var checkbox_values = get_checkbox_values();
                for (var i = 0; i < checkbox_values.length; i++) {
                  if ($(checkbox_values[i]).prop("checked")) {
                    checkbox_count++;
                  }
                }

                if ($(this).prop("checked")) {
                  $('div#bulk_edit_menu').removeClass('hidden');
                } else {
                  checkbox_count--;
                  var checkbox_values = get_checkbox_values();
                  var checked = false;

                  for (var i = 0; i < checkbox_values.length; i++) {
                    if ($(checkbox_values[i]).prop("checked")) {
                      checked = true;
                    }
                  }
                  if (checked == false) {
                    $('div#bulk_edit_menu').addClass('hidden');
                  }
                }

              }
            });
            $('form#bulk_change_form').on('submit', function(e){
                $('input[type=checkbox].select_one:checked').each(function(){
                    var hidden_input = $('<input type="hidden" value="' + this.id + '" name="endpoints_to_update">')
                    $('form#bulk_change_form').append(hidden_input);
                });
            });

            $('input#select_all_vulnerable').on('click', function (e) {
                var checkbox_values = $("input[type=checkbox][name^='select_vulnerable']");
                if ($(this).is(":checked")) {
                    for (var i = 0; i < checkbox_values.length; i++) {
                        $(checkbox_values[i]).prop('checked', true)
                    }
                    $('div#bulk_edit_menu').removeClass('hidden');
                }
                else {
                    for (var i = 0; i < checkbox_values.length; i++) {
                        $(checkbox_values[i]).prop('checked', false)
                    }
                    $('div#bulk_edit_menu').addClass('hidden');
                }
            });

             $('input#select_all_mitigated').on('click', function (e) {
                var checkbox_values = $("input[type=checkbox][name^='select_mitigated']");
                if ($(this).is(":checked")) {
                    for (var i = 0; i < checkbox_values.length; i++) {
                        $(checkbox_values[i]).prop('checked', true)
                    }
                    $('div#bulk_edit_menu').removeClass('hidden');
                }
                else {
                    for (var i = 0; i < checkbox_values.length; i++) {
                        $(checkbox_values[i]).prop('checked', false)
                    }
                    $('div#bulk_edit_menu').addClass('hidden');
                }
            });
        });

        var clipboard = new ClipboardJS('.copytoclipboard');

        function submit_related_action(url) {
            var related_action_form = $('#related_action')
            {% comment %} alert(url) {% endcomment %}
            related_action_form.attr('action', url)
            related_action.submit()
        }

        {% comment %} $('#show-filters').on('click', function () {
            $(this).toggleClass("dropup");
        })

        $(".dojo-filter-set :input").not("button").addClass("form-control input-sm"); {% endcomment %}

    </script>

    <script type="application/javascript">
        // DataTables Setup
        $(document).ready(function() {
            date =  new Date().toISOString().slice(0, 10);
            var fileDated = 'Debt_Items_List_' + date;
            var columns = [
                { "data": "relationship" },
                { "data": "severity" },
                { "data": "debt_item" , render: function (data, type, row) {
                        return type === 'export' ? getDojoExportValueFromTag(data, 'a') :  data;
                }},
                { "data": "found_date" },
                { "data": "status" },
                { "data": "debt_test" },
                { "data": "debt_context" },
                { "data": "debt_engagement" },
                //{ "data": "cwe" },
                //{ "data": "cve" },
                //{ "data": "file_path" },
                {% if system_settings.enable_jira %}
                    { "data": "jira_id" },
                {% endif %}
                { "data": "action" },
              ];

            // Filter the list of items to display based on what is shown.
            var disallowed_entries = new Set(["checkbox", "action"]);
            var data_column_list = [];
            for (var i = 0; i < columns.length; i++) {
                if (!disallowed_entries.has(columns[i]["data"])) {
                    data_column_list.push(i);
                }
            }

            var buttonCommon = {
                exportOptions: {
                    columns: data_column_list,
                    stripHtml: true,
                    stripNewlines: true,
                    trim: true,
                    orthogonal: 'export'
                },
                filename: fileDated,
                title: 'Similar Debt Items List'
            };

            // Mapping of table columns to objects for proper cleanup and data formatting
            var dojoTable = $('#similar_debt_items_table').DataTable({
                drawCallback: function(){
                    $('#similar_debt_items_table .has-popover').hover(
                        function() { $(this).popover('show'); }, // hover
                        function() { $(this).popover('hide'); } // unhover
                    );
                },
                colReorder: true,
                "columns": columns,
                order: [],
                columnDefs: [
                    {
                        "orderable": false,
                        "targets": [0, 1]
                    },
                    {
                        targets: [0, 1],
                        className: 'noVis'
                    }
                ],
                dom: 'Bfrtip',
                paging: false,
                info: false,
                buttons: [
                    {
                        extend: 'colvis',
                        columns: ':not(.noVis)'
                    },
                    $.extend( true, {}, buttonCommon, {
                        extend: 'copy'
                    }),
                    $.extend( true, {}, buttonCommon, {
                        extend: 'excel',
                        autoFilter: true,
                        sheetName: 'Exported data',
                    }),
                    $.extend( true, {}, buttonCommon, {
                        extend: 'csv'
                    }),
                    $.extend( true, {}, buttonCommon, {
                        extend: 'pdf',
                        orientation: 'landscape',
                        pageSize: 'LETTER'
                    }),
                    $.extend( true, {}, buttonCommon, {
                        extend: 'print'
                    }),
                ],
            });
        });
    </script>

    {% include "dojo/filter_js_snippet.html" %}
{% endblock %}
</div>