{% extends "debt_base.html" %}
{% load event_tags %}
{% load display_tags %}
{% load static %}
{% block add_css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static "easymde/dist/easymde.min.css" %}">
{% endblock %}
{% block add_styles %}
    {{ block.super }}
    .chosen-container {
    width: 70% !important;
    }
    .editor-toolbar, .editor-statusbar, .editor-preview-side, .CodeMirror {
    width: 70% !important;
    }
{% endblock %}
{% block content %}
    {{ block.super }}
    <h3> Edit a Debt Item </h3>
    {% if temp %}
        <form id="add_debt_item" class="form-horizontal" action="{% url 'edit_debt_item' debt_item.id %}" method="post">
            {% csrf_token %}
            {% include "dojo/form_fields.html" with form=form %}
            {% if jform %}
                <h4> JIRA </h4>
                <hr>
                {% include "dojo/form_fields.html" with form=jform %}
            {% endif %}
            {% if gform %}
                <h3> GitHub </h3>
                <hr>
                {% include "dojo/form_fields.html" with form=gform %}
            {% endif %}
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10">
                    <input type="submit" value="Add Another Debt Item"/>
                    <input type="submit" value="Finished"/>
                </div>
            </div>
        </form>
    {% else %}
        <form id="add_debt_item" class="form-horizontal" action="{% url 'edit_debt_item' debt_item.id %}" method="post">
            {% csrf_token %}
            {% if return_url %}
                <input type="hidden" name="return_url" value="{{ return_url }}" />
            {% endif %}
            {% include "dojo/form_fields.html" with form=form %}
            {% block additional_forms %}
            {% endblock additional_forms %}
            <span id="original_debt_item" class="small">
                {% if debt_item.duplicate_debt_item %}
                    [original:
                    <a href="{% url 'view_debt_item' debt_item.duplicate_debt_item.id %}">{{ debt_item.duplicate_debt_item.id }} : {{ debt_item.duplicate_debt_item.title }}</a>/
                    <a href="{% url 'view_debt_context' debt_item.duplicate_debt_item.debt_test.debt_engagement.debt_context.id %}">{{ debt_item.duplicate_debt_item.debt_test.debt_engagement.debt_context.name }}</a>/
                    <a href="{% url 'view_debt_engagement' debt_item.duplicate_debt_item.debt_test.debt_engagement.id %}">{{ debt_item.duplicate_debt_item.debt_test.debt_engagement.name }}</a>
                    {% if debt_item.duplicate_debt_item.debt_test.title %}
                        {{debt_item.duplicate_debt_item.debt_test.title}}
                    {% else %}
                        {{debt_item.duplicate_debt_item.debt_test.debt_test_type}}
                    {% endif %}
                    {% if debt_item.duplicate_debt_item.cve %}
                        {% if debt_item.duplicate_debt_item.cve|has_vulnerability_url %}
                            <a href="{{debt_item.duplicate_debt_item.cve|vulnerability_url}}">({{debt_item.duplicate_debt_item.cve}})</a>
                        {% else %}
                            {{ debt_item.duplicate_debt_item.cve }}
                        {% endif %}
                    {% endif %}
                    {% if debt_item.duplicate_debt_item.cwe > 0 %}
                        <a href="{{debt_item.duplicate_debt_item.cwe|cwe_url}}">(CWE-{{debt_item.duplicate_debt_item.cwe}})</a>
                    {% endif %}
                    {% if debt_item.duplicate_debt_item.jira_issue %}
                        <a href="{{ debt_item.duplicate_debt_item | jira_issue_url }}"
                        target="_blank" title="{{ debt_item.duplicate_debt_item | jira_issue_url }}">{{ debt_item.duplicate_debt_item | jira_key }}</a>
                    {% endif %}
                    ]
                {% endif %}
            </span>

            {% if jform %}
                <h4> JIRA </h4>
                <hr>
                <div class="form-group">
                    <label class="col-sm-2 control-label" for="id_jira_issue">JIRA URL
                        <i class="fa-solid fa-circle-question has-popover" data-trigger="hover" data-content="JIRA URL connected to this debt_items debt_context or debt_engagement" data-placement="right" data-container="body" data-original-title="" title="">
                        </i>
                    </label>
                    <div class="col-sm-10 form-control-static">
                        {% if debt_item.has_jira_group_issue %}
                            <a href="{{ debt_item.debt_item_group | jira_issue_url }}"
                            target="_blank" title="{{ debt_item.debt_item_group | jira_issue_url }} (group)">{{ debt_item.debt_item_group | jira_issue_url }} (group)</a>
                        {% elif debt_item.has_jira_issue %}
                            <a href="{{ debt_item | jira_issue_url }}"
                            target="_blank"> {{ debt_item | jira_issue_url }} </a>
                        {% else %}
                            <a href="{{ debt_item | jira_project_url }}"
                            target="_blank"> {{ debt_item | jira_project_url }} </a>
                        {% endif %}
                    </div>
                </div>
                {% include "dojo/form_fields.html" with form=jform %}
            {% endif %}
            {% if gform %}
                <h4> GitHub </h4>
                <hr>
                <div class="form-group">
                    <label class="col-sm-2 control-label" for="id_github_issue">GitHub issue
                        <i class="fa-solid fa-circle-question has-popover" data-trigger="hover" data-content="Github issue connected to this debt_item" data-placement="right" data-container="body" data-original-title="" title="">
                        </i>
                    </label>
                    <div class="col-sm-10 form-control-static">
                        {% if debt_item.github_issue and debt_item.github_conf_new %}
                            <a href="{{ debt_item.github_issue.issue_url }}" target="_blank" title="{{ debt_item.github_issue.issue_url }}">{{debt_item.github_issue.issue_url}}</a>
                        {% else %}
                            None
                        {% endif %}
                    </div>
                </div>
                 {% include "dojo/form_fields.html" with form=gform %}
            {% endif %}
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10">
                    <input class="btn btn-primary" name="_Finished" type="submit" value="Finished"/>
                </div>
            </div>
        </form>
    {% endif %}

{% endblock %}
{% block postscript %}
    {{ block.super }}
    <script type="application/javascript" src="{% static "jquery.hotkeys/jquery.hotkeys.js" %}"></script>
    <script type="application/javascript" src="{% static "easymde/dist/easymde.min.js" %}"></script>
    <script type="text/javascript" src="{% static "admin/js/jquery.init.js" %}"></script>
    <script type="application/javascript" src="{% static "admin/js/admin/RelatedObjectLookups.js" %}"></script>
    <script type="application/javascript">
        $ = django.jQuery;
        $.hotkeys.options.filterInputAcceptingElements = false;
        $.hotkeys.options.filterTextInputs = false;
		
        var tmp_val = null;
		
        if ($('#id_mitigated').val() != null) {
            $('#id_mitigated').val($('#id_mitigated').val().slice(0,10));
            var tmp_val = $('#id_mitigated').val();
        }
		
        function displayMitigated() {
            var elMitigated = $('#id_mitigated').closest('.form-group'),
                elMitigatedBy = $('#id_mitigated_by').closest('.form-group'),
                elActive = $('#id_active')[0];

            if (!elActive.checked) {
                elMitigated.show('fast');
				$('#id_mitigated').val(tmp_val);
                elMitigatedBy.show('fast');
            } else {
                elMitigated.hide('fast');
				$('#id_mitigated').val('');
                elMitigatedBy.hide('fast');
            }
        }

        $(function () {
            $('[data-toggle="tooltip"]').tooltip()

            $(document).bind('keydown', 'ctrl+s', function (event) {
                if (event.preventDefault) {
                    event.preventDefault();
                } else {
                    // internet explorer
                    event.returnValue = false;
                }
                $("form#add_debt_item").submit();
            });

            $("textarea").each(function (index, elem) {
                if (elem.hasAttribute("required")) {
                    elem.removeAttribute("required");
                    elem.id = "req"
                }

                if (elem.name != 'debt_endpoints_to_add' && elem.name != 'vulnerability_ids' && !$(elem).hasClass('select2-search__field')) {
                    var mde = new EasyMDE({
                        spellChecker: false,
                        element: elem,
                        autofocus: false,
                        forceSync: true,
                        toolbar: ["bold", "italic", "heading", "|",
                            "quote", "unordered-list", "ordered-list", "|",
                            "link", "image", "|",
                            "table", "horizontal-rule", "code", "|",
                            "guide"
                        ]
                    });
                    mde.render();
                }
            });

            displayMitigated();
            $('#id_active').change(displayMitigated);
        });

        {% comment %} crazy legacy stuff to force the original debt_item to be displayede at the right place {% endcomment %}
        window.onload = function() {
            var original_debt_item = document.getElementById("original_debt_item")
            var duplicate_checkbox = document.getElementById("id_duplicate").parentElement.parentElement
            if ($("#id_duplicate").prop("checked")) {
                $("#id_duplicate").parent().parent().append(original_debt_item)
            } else {
                $("#id_duplicate").click(function(){ alert('debt_items can only be marked as duplicates from the view debt_item screen'); return false; });
            }
        };

        $("#add_debt_item").submit(function () {
            var isFormValid = true;

            $("textarea#req").each(function () {
                if ($.trim($(this).val()).length == 0) {
                    $(this).addClass("highlight");
                    isFormValid = false;
                }
                else {
                    $(this).removeClass("highlight");
                }
            });

            if (!isFormValid) alert("Please fill in all the required fields (indicated by *)");

            return isFormValid;
        });
    </script>

{% endblock %}
